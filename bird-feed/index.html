<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bird Feed - The Straight Flight</title>
    <style>
        body {
            background-color: #2c3e50;
            color: #ecf0f1;
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }
        #game-container {
            position: relative;
            border: 4px solid #34495e;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        canvas {
            display: block;
            background-color: #34495e;
        }
        #ui {
            margin-top: 20px;
            text-align: center;
        }
        .info {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }
        .controls {
            font-size: 0.9rem;
            color: #bdc3c7;
        }
        #message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 10px;
            display: none;
            text-align: center;
        }
        button {
            padding: 10px 20px;
            font-size: 1rem;
            background: #27ae60;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 5px;
            margin-top: 10px;
        }
        button:hover {
            background: #2ecc71;
        }
        #home-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #e67e22;
        }
        #home-btn:hover {
            background: #d35400;
        }
    </style>
</head>
<body>
    <button id="home-btn" onclick="location.href='../index.html'">Back to Home</button>

    <div id="game-container">
        <canvas id="gameCanvas" width="500" height="500"></canvas>
        <div id="message">
            <h2 id="msg-text">Level Complete!</h2>
            <button onclick="nextLevel()">Next Level</button>
        </div>
    </div>

    <div id="ui">
        <div class="info">Level: <span id="level-num">1</span> | Worms Remaining: <span id="worm-count">0</span></div>
        <div class="controls">Use ARROW KEYS to fly. Once you start, you can't stop until you hit a wall!</div>
        <div class="controls">Avoid the OWLS that chase you!</div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const levelDisplay = document.getElementById('level-num');
        const wormDisplay = document.getElementById('worm-count');
        const messageBox = document.getElementById('message');
        const messageText = document.getElementById('msg-text');

        const TILE_SIZE = 50;
        const GRID_SIZE = 10;

        let level = 1;
        let player = { x: 1, y: 1 };
        let worms = [];
        let owls = [];
        let walls = [];
        let moving = false;
        let gameOver = false;

        // Level Definitions
        const levels = [
            {
                map: [
                    "##########",
                    "#P......##",
                    "#........#",
                    "#...#....#",
                    "#...#..W.#",
                    "#...#....#",
                    "#......W.#",
                    "#........#",
                    "#...W....#",
                    "##########"
                ]
            },
            {
                map: [
                    "##########",
                    "#P.......#",
                    "#..##....#",
                    "#..#..W..#",
                    "#..#.....#",
                    "#..#..O..#",
                    "#.......##",
                    "#..W.....#",
                    "#........#",
                    "##########"
                ]
            },
            {
                map: [
                    "##########",
                    "#P......##",
                    "#..####..#",
                    "#..#W.#..#",
                    "#..#..#..#",
                    "#..#W.O..#",
                    "#..#..##.#",
                    "#..####..#",
                    "#..O.....#",
                    "##########"
                ]
            },
            {
                map: [
                    "##########",
                    "#W#....#.#",
                    "#.#......#",
                    "#.#..#.#.#",
                    "#....#W#O#",
                    "####.###.#",
                    "#P...#...#",
                    "#....#.#.#",
                    "#.....W#.#",
                    "##########"
                ]
            },
            {
                map: [
                    "##########",
                    "#W......W#",
                    "#.######.#",
                    "#.#....#.#",
                    "#.##..P#.#",
                    "#.#......#",
                    "#.#....#.#",
                    "#.######.#",
                    "#W......W#",
                    "##########"
                ]
            }
        ];

        function initLevel() {
            if (level > levels.length) {
                showMessage("You've collected all worms and escaped the owls!", "Play Again", () => {
                    level = 1;
                    initLevel();
                });
                return;
            }
            const currentLevel = levels[level - 1];
            walls = [];
            worms = [];
            owls = [];
            
            for (let y = 0; y < currentLevel.map.length; y++) {
                for (let x = 0; x < currentLevel.map[y].length; x++) {
                    const char = currentLevel.map[y][x];
                    if (char === '#') {
                        walls.push({ x, y });
                    } else if (char === 'P') {
                        player = { x, y };
                    } else if (char === 'W') {
                        worms.push({ x, y });
                    } else if (char === 'O') {
                        owls.push({ x, y });
                    }
                }
            }
            
            // Add extra owls based on level if not explicitly in map
            if (level >= 4) {
                // Procedural generation or just repeat last level with more owls
                // For now, let's just use the maps provided.
            }

            wormDisplay.innerText = worms.length;
            levelDisplay.innerText = level;
            messageBox.style.display = 'none';
            gameOver = false;
            moving = false;
            draw();
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw Walls
            ctx.fillStyle = '#2c3e50';
            walls.forEach(w => {
                ctx.fillRect(w.x * TILE_SIZE, w.y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                ctx.strokeStyle = '#34495e';
                ctx.strokeRect(w.x * TILE_SIZE, w.y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            });

            // Draw Worms
            ctx.fillStyle = '#e67e22';
            worms.forEach(w => {
                ctx.beginPath();
                ctx.arc(w.x * TILE_SIZE + TILE_SIZE/2, w.y * TILE_SIZE + TILE_SIZE/2, 10, 0, Math.PI * 2);
                ctx.fill();
            });

            // Draw Owls
            ctx.fillStyle = '#e74c3c';
            owls.forEach(o => {
                ctx.beginPath();
                ctx.moveTo(o.x * TILE_SIZE + 10, o.y * TILE_SIZE + 10);
                ctx.lineTo(o.x * TILE_SIZE + 40, o.y * TILE_SIZE + 10);
                ctx.lineTo(o.x * TILE_SIZE + 25, o.y * TILE_SIZE + 40);
                ctx.closePath();
                ctx.fill();
                // Eyes
                ctx.fillStyle = 'white';
                ctx.fillRect(o.x * TILE_SIZE + 15, o.y * TILE_SIZE + 15, 5, 5);
                ctx.fillRect(o.x * TILE_SIZE + 30, o.y * TILE_SIZE + 15, 5, 5);
                ctx.fillStyle = '#e74c3c';
            });

            // Draw Player (Bird)
            ctx.fillStyle = '#f1c40f';
            ctx.beginPath();
            ctx.arc(player.x * TILE_SIZE + TILE_SIZE/2, player.y * TILE_SIZE + TILE_SIZE/2, 18, 0, Math.PI * 2);
            ctx.fill();
            // Beak
            ctx.fillStyle = '#e67e22';
            ctx.beginPath();
            ctx.moveTo(player.x * TILE_SIZE + 35, player.y * TILE_SIZE + 25);
            ctx.lineTo(player.x * TILE_SIZE + 45, player.y * TILE_SIZE + 25);
            ctx.lineTo(player.x * TILE_SIZE + 35, player.y * TILE_SIZE + 30);
            ctx.fill();
        }

        function isWall(x, y) {
            return walls.some(w => w.x === x && w.y === y);
        }

        async function movePlayer(dx, dy) {
            if (moving || gameOver) return;
            moving = true;

            let lastX = player.x;
            let lastY = player.y;
            let moved = false;

            while (!isWall(player.x + dx, player.y + dy)) {
                player.x += dx;
                player.y += dy;
                moved = true;

                // Check for worm collection during flight
                worms = worms.filter(w => {
                    if (w.x === player.x && w.y === player.y) {
                        return false;
                    }
                    return true;
                });
                wormDisplay.innerText = worms.length;

                draw();
                await new Promise(r => setTimeout(r, 50)); // Animation delay

                if (checkDeath()) break;
            }

            if (moved && !gameOver) {
                moveOwls();
                if (checkDeath()) {
                    // Death handled in checkDeath
                } else if (worms.length === 0) {
                    showMessage("Level Complete!", "Next Level", () => {
                        level++;
                        initLevel();
                    });
                }
            }

            moving = false;
        }

        function moveOwls() {
            owls.forEach(o => {
                let dx = player.x - o.x;
                let dy = player.y - o.y;

                let moveX = 0;
                let moveY = 0;

                if (Math.abs(dx) > Math.abs(dy)) {
                    moveX = dx > 0 ? 1 : -1;
                } else {
                    moveY = dy > 0 ? 1 : -1;
                }

                // If primary direction is blocked, try secondary
                if (isWall(o.x + moveX, o.y + moveY)) {
                    if (moveX !== 0) {
                        moveX = 0;
                        moveY = dy > 0 ? 1 : -1;
                    } else {
                        moveY = 0;
                        moveX = dx > 0 ? 1 : -1;
                    }
                }

                if (!isWall(o.x + moveX, o.y + moveY)) {
                    o.x += moveX;
                    o.y += moveY;
                }
            });
            draw();
        }

        function checkDeath() {
            if (owls.some(o => o.x === player.x && o.y === player.y)) {
                gameOver = true;
                showMessage("Caught by an owl!", "Restart Level", () => {
                    initLevel();
                });
                return true;
            }
            return false;
        }

        function showMessage(text, btnText, callback) {
            messageText.innerText = text;
            const btn = messageBox.querySelector('button');
            btn.innerText = btnText;
            btn.onclick = callback;
            messageBox.style.display = 'block';
        }

        window.addEventListener('keydown', e => {
            if (moving || gameOver) return;
            switch(e.key) {
                case 'ArrowUp': movePlayer(0, -1); break;
                case 'ArrowDown': movePlayer(0, 1); break;
                case 'ArrowLeft': movePlayer(-1, 0); break;
                case 'ArrowRight': movePlayer(1, 0); break;
            }
        });

        initLevel();
    </script>
</body>
</html>
